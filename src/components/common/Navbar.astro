---
import Logo from "../../assets/logo.png";
import Image from "astro/components/Image.astro";
import CommonButton from "./CommonButton.astro";

// Get current URL to determine active page
const currentPath = Astro.url.pathname;
---

<aside id="wrapper-sidebar">
  <div
    id="sidebar"
    class="fixed top-0 left-0 z-50 h-screen w-[65px] bg-[#f8f8f8] xl:w-[88px]"
  >
    <svg
      width="13"
      height="52"
      viewBox="0 0 13 52"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
      class="mx-auto mt-4"
    >
      <line x1="0.5" y1="0" x2="0.5" y2="52" stroke="#000047"></line>
      <line x1="12.5" y1="0" x2="12.5" y2="52" stroke="#000047"></line>
    </svg>
    <div class="absolute right-2 h-[95%] w-[1px] bg-[#DADEFF]"></div>
    <div class="absolute top-4 right-2 h-[10%] w-[1.5px] bg-[#606DD1]"></div>
  </div>
</aside>

<nav
  class="fixed top-0 right-0 left-[65px] z-50 flex w-[calc(100vw-65px)] xl:left-[88px] xl:w-[calc(100vw-88px)]"
>
  <div class="flex w-full justify-between">
    <div
      id="nav-container"
      class="flex items-center bg-[#f8f8f8] px-3 py-1.5 shadow-xs transition-all duration-300 md:px-4 md:py-2 lg:px-4 lg:py-2"
    >
      <div
        class="flex max-w-[100px] min-w-[100px] items-center md:mr-6 lg:mr-8 xl:mr-10 xl:min-w-[120px] 2xl:mr-12 2xl:min-w-[170px]"
      >
        <a href="/">
          <Image
            src={Logo}
            alt="Nixxon Tech Logo"
            class="h-auto w-full max-w-[100px] min-w-[100px] xl:min-w-[120px] 2xl:min-w-[170px]"
          />
        </a>
      </div>

      <ul
        class="3xl:text-xl hidden items-center gap-x-2 text-sm font-medium text-nowrap text-[#000000] md:flex md:gap-x-4 md:text-base lg:gap-x-6 lg:text-[15px] xl:gap-x-10 2xl:gap-x-12 2xl:text-lg"
      >
        <li>
          <a
            href="/"
            class={`3xl:px-4 3xl:py-3 rounded-full px-2.5 py-1.5 text-sm md:text-base xl:px-3 xl:py-2 transition-all duration-200 ${
              currentPath === '/' 
                ? 'bg-[#9D7EFF] text-white shadow-md' 
                : 'hover:bg-[#9D7EFF]/10 hover:text-[#9D7EFF]'
            }`}
          >Home</a>
        </li>
        <li>
          <a 
            href="/about" 
            class={`rounded-full px-2.5 py-1.5 text-sm md:text-base xl:px-3 xl:py-2 transition-all duration-200 ${
              currentPath === '/about' 
                ? 'bg-[#9D7EFF] text-white shadow-md' 
                : 'hover:bg-[#9D7EFF]/10 hover:text-[#9D7EFF]'
            }`}
          >About Us</a>
        </li>
        <li class="group relative" id="services-dropdown-container">
          <button 
            id="services-dropdown-toggle"
            class={`flex items-center space-x-1 rounded-full px-2.5 py-1.5 text-sm md:text-base xl:px-3 xl:py-2 transition-all duration-200 ${
              currentPath.startsWith('/services/') 
                ? 'bg-[#9D7EFF] text-white shadow-md' 
                : 'hover:bg-[#9D7EFF]/10 hover:text-[#9D7EFF] group-hover:bg-[#9D7EFF]/10 group-hover:text-[#9D7EFF]'
            }`}
            aria-expanded="false"
            aria-controls="services-dropdown-menu"
          >
            <span>Services</span>
            <svg
              id="services-dropdown-arrow"
              class="h-3.5 w-3.5 md:h-4 md:w-4 transition-transform duration-200 group-hover:rotate-180"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
          <ul
            id="services-dropdown-menu"
            class="absolute left-0 pt-2 hidden w-56 overflow-hidden rounded-xl border border-gray-200 bg-white text-sm shadow-xl group-hover:block md:w-64 md:text-base animate-fade-in"
            aria-labelledby="services-dropdown-toggle"
          >
            <li>
              <a
                href="/services/web-development"
                class={`block px-4 py-3 transition-all duration-150 border-l-4 ${
                  currentPath === '/services/web-development'
                    ? 'bg-[#9D7EFF]/10 text-[#9D7EFF] border-l-[#9D7EFF] font-semibold'
                    : 'border-l-transparent hover:bg-[#9D7EFF]/5 hover:border-l-[#9D7EFF]/50 hover:text-[#9D7EFF] hover:pl-5'
                }`}
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                  </svg>
                  <span>Web Development</span>
                </div>
              </a>
            </li>

            <li>
              <a
                href="/services/logo-design"
                class={`block px-4 py-3 transition-all duration-150 border-l-4 ${
                  currentPath === '/services/logo-design'
                    ? 'bg-[#9D7EFF]/10 text-[#9D7EFF] border-l-[#9D7EFF] font-semibold'
                    : 'border-l-transparent hover:bg-[#9D7EFF]/5 hover:border-l-[#9D7EFF]/50 hover:text-[#9D7EFF] hover:pl-5'
                }`}
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                  </svg>
                  <span>Logo Design</span>
                </div>
              </a>
            </li>

            <li>
              <a
                href="/services/branding"
                class={`block px-4 py-3 transition-all duration-150 border-l-4 ${
                  currentPath === '/services/branding'
                    ? 'bg-[#9D7EFF]/10 text-[#9D7EFF] border-l-[#9D7EFF] font-semibold'
                    : 'border-l-transparent hover:bg-[#9D7EFF]/5 hover:border-l-[#9D7EFF]/50 hover:text-[#9D7EFF] hover:pl-5'
                }`}
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-1.757l4.9-4.9a2 2 0 000-2.828L13.485 5.1a2 2 0 00-2.828 0L10 5.757v8.486zM16 18H9.071l6-6H16a2 2 0 012 2v2a2 2 0 01-2 2z" clip-rule="evenodd"/>
                  </svg>
                  <span>Branding</span>
                </div>
              </a>
            </li>

            <!-- New service items -->
            <li>
              <a
                href="/services/digital-marketing"
                class={`block px-4 py-3 transition-all duration-150 border-l-4 ${
                  currentPath === '/services/digital-marketing'
                    ? 'bg-[#9D7EFF]/10 text-[#9D7EFF] border-l-[#9D7EFF] font-semibold'
                    : 'border-l-transparent hover:bg-[#9D7EFF]/5 hover:border-l-[#9D7EFF]/50 hover:text-[#9D7EFF] hover:pl-5'
                }`}
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M3 3h14v2H3V3zm2 4h10v2H5V7zm-2 4h14v6H3v-6z"/></svg>
                  <span>Digital Marketing</span>
                </div>
              </a>
            </li>

            <li>
              <a
                href="/services/mobile-application"
                class={`block px-4 py-3 transition-all duration-150 border-l-4 ${
                  currentPath === '/services/mobile-application'
                    ? 'bg-[#9D7EFF]/10 text-[#9D7EFF] border-l-[#9D7EFF] font-semibold'
                    : 'border-l-transparent hover:bg-[#9D7EFF]/5 hover:border-l-[#9D7EFF]/50 hover:text-[#9D7EFF] hover:pl-5'
                }`}
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M7 2h6v1H7V2zm6 15H7V4h6v13zM9 18h2v1H9v-1z"/></svg>
                  <span>Mobile Application</span>
                </div>
              </a>
            </li>

            <li>
              <a
                href="/services/video-animation"
                class={`block px-4 py-3 transition-all duration-150 border-l-4 ${
                  currentPath === '/services/video-animation'
                    ? 'bg-[#9D7EFF]/10 text-[#9D7EFF] border-l-[#9D7EFF] font-semibold'
                    : 'border-l-transparent hover:bg-[#9D7EFF]/5 hover:border-l-[#9D7EFF]/50 hover:text-[#9D7EFF] hover:pl-5'
                }`}
              >
                <div class="flex items-center space-x-3">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4h8v12H4zM14 7l4 3-4 3V7z"/></svg>
                  <span>Video Animation</span>
                </div>
              </a>
            </li>
          </ul>
        </li>
        <!-- <li>
          <a 
            href="/portfolio" 
            class={`rounded-full px-2.5 py-1.5 text-sm md:text-base xl:px-3 xl:py-2 transition-all duration-200 ${
              currentPath === '/portfolio' 
                ? 'bg-[#9D7EFF] text-white shadow-md' 
                : 'hover:bg-[#9D7EFF]/10 hover:text-[#9D7EFF]'
            }`}
          >Portfolio</a>
        </li> -->
      </ul>

      <div
        id="inner-button"
        class="pointer-events-none my-auto ml-auto opacity-0 transition-opacity duration-300"
      >
        <CommonButton
          className="my-auto mr-2 px-2.5 py-1.5 text-sm md:mr-4 xl:px-4 xl:py-2 xl:text-base"
        >
          Book A discovery call
        </CommonButton>
      </div>
    </div>

    <div id="outer-button" class="my-auto transition-opacity duration-300">
      <CommonButton
        className="my-4 mr-2 px-2.5 py-1.5 text-sm md:mr-8 md:px-3 md:py-2 md:text-base lg:px-4 xl:px-6"
      >
        Book A discovery call
      </CommonButton>
    </div>
  </div>
</nav>

<script>
  import { gsap, ScrollTrigger } from "../../utils/gsapUtils.js";

  document.addEventListener("DOMContentLoaded", () => {
    const navContainer = document.getElementById("nav-container");
    const innerButton = document.getElementById("inner-button");
    const outerButton = document.getElementById("outer-button");

    if (!navContainer || !innerButton || !outerButton) return;

    // Services dropdown functionality
    const dropdownContainer = document.getElementById("services-dropdown-container");
    const dropdownToggle = document.getElementById("services-dropdown-toggle");
    const dropdownMenu = document.getElementById("services-dropdown-menu");
    const dropdownArrow = document.getElementById("services-dropdown-arrow");
    
    if (dropdownToggle && dropdownMenu && dropdownArrow) {
      let isDropdownOpen = false;
      
      // Toggle dropdown on click
      dropdownToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        isDropdownOpen = !isDropdownOpen;
        
        // Update aria-expanded
        dropdownToggle.setAttribute("aria-expanded", isDropdownOpen.toString());
        
        // Toggle display
        if (isDropdownOpen) {
          dropdownMenu.classList.add("block");
          dropdownMenu.classList.remove("hidden");
          dropdownArrow.classList.add("rotate-180");
        } else {
          closeDropdown();
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (isDropdownOpen && !dropdownContainer.contains(e.target)) {
          closeDropdown();
        }
      });
      
      // Stop propagation for dropdown menu clicks to prevent closing
      dropdownMenu.addEventListener("click", (e) => {
        e.stopPropagation();
      });
      
      // Ensure keyboard navigation works properly
      dropdownToggle.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          dropdownToggle.click();
        } else if (e.key === "Escape" && isDropdownOpen) {
          closeDropdown();
        } else if (e.key === "ArrowDown" && isDropdownOpen) {
          e.preventDefault();
          const firstItem = dropdownMenu.querySelector("a");
          if (firstItem) firstItem.focus();
        }
      });
      
      // Focus management within dropdown
      const dropdownItems = dropdownMenu.querySelectorAll("a");
      dropdownItems.forEach((item, index) => {
        item.addEventListener("keydown", (e) => {
          if (e.key === "ArrowDown") {
            e.preventDefault();
            const nextItem = dropdownItems[index + 1] || dropdownItems[0];
            nextItem.focus();
          } else if (e.key === "ArrowUp") {
            e.preventDefault();
            const prevItem = dropdownItems[index - 1] || dropdownItems[dropdownItems.length - 1];
            prevItem.focus();
          } else if (e.key === "Escape") {
            closeDropdown();
            dropdownToggle.focus();
          }
        });
      });
      
      // When hovering off dropdown container, keep dropdown open if it was clicked open
      dropdownContainer.addEventListener("mouseleave", () => {
        // Only close if it wasn't explicitly opened by click
        if (!isDropdownOpen) {
          // Add a small delay to allow moving to the dropdown
          setTimeout(() => {
            // Only close if not hovered and not explicitly opened
            if (!dropdownContainer.matches(":hover") && !isDropdownOpen) {
              closeDropdown();
            }
          }, 100);
        }
      });
      
      // Function to close dropdown
      function closeDropdown() {
        isDropdownOpen = false;
        dropdownToggle.setAttribute("aria-expanded", "false");
        dropdownMenu.classList.remove("block");
        dropdownMenu.classList.add("hidden");
        dropdownArrow.classList.remove("rotate-180");
      }

      // Fix for touch devices - make first touch open the menu
      if ('ontouchstart' in window) {
        dropdownToggle.addEventListener('touchstart', (e) => {
          if (!isDropdownOpen) {
            e.preventDefault();
            dropdownToggle.click();
          }
        });
      }
    }

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: ".hero-section",
        start: "bottom 5%",
        end: "bottom top",
        scrub: 0.01,
        toggleActions: "play none none reverse",
      },
    });

    tl.fromTo(
      navContainer,
      {
        width: "60%",
        borderTopRightRadius: "-50px",
        borderBottomRightRadius: "1.5rem",
      },
      {
        width: "100%",
        borderRadius: 0,
        ease: "power2.inOut",
        duration: 0.3,
        borderBottom: "1px",
        borderBottomColor: "black",
      },
    )
      // Fade OUT the outer button at the same time the nav expands
      .fromTo(
        outerButton,
        { opacity: 1, pointerEvents: "auto" },
        { opacity: 0, pointerEvents: "none", duration: 0.18, display: "none" },
        "<", // start with nav expand
      )
      // Fade IN the inner button after the outer has faded out
      .fromTo(
        innerButton,
        { opacity: 0, pointerEvents: "none" },
        {
          opacity: 1,
          pointerEvents: "auto",
          duration: 0.18,
          marginTop: "1rem",
          marginBottom: "1rem",
        },
        ">", // start after previous tween finishes
      );

    const sidebar = document.getElementById("wrapper-sidebar");
    const nav = document.querySelector("nav");
    if (sidebar) {
      ScrollTrigger.create({
        trigger: sidebar,
        start: "top top",
        endTrigger: ".our-services",
        end: "bottom top",
        pin: true,
        anticipatePin: 1,
        // markers:true,
        onLeave: () => {
          // Detect if screen is xl or above (using 1280px as Tailwind's xl)
          const isXL = window.innerWidth >= 1280;
          nav.style.left = isXL ? "0" : "0";
          nav.style.width = "100vw";
          nav.classList.remove(
            isXL ? "left-[88px]" : "left-[65px]",
            isXL ? "w-[calc(100vw-88px)]" : "w-[calc(100vw-65px)]",
          );
          nav.classList.add("w-full");
          sidebar.style.display = "none";
        },
        onEnterBack: () => {
          const isXL = window.innerWidth >= 1280;
          nav.style.left = isXL ? "88px" : "65px";
          nav.style.width = "";
          nav.classList.remove("w-full");
          nav.classList.add(
            isXL ? "left-[88px]" : "left-[65px]",
            isXL ? "w-[calc(100vw-88px)]" : "w-[calc(100vw-65px)]",
          );
          sidebar.style.display = "";
        },
      });
    }
  });
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>